#!/usr/bin/env bash
set -euo pipefail

warn() { echo 1>&2 "WARNING:" "$@"; }

####################################################################

export T8_PROJDIR=$(cd "$(dirname "$0")" && pwd -P)
t8dir=t8dev    # or whatever your submodule path is
[[ -r $T8_PROJDIR/$t8dir/t8setup.bash ]] \
    || git submodule update --init "$T8_PROJDIR/$t8dir"
. "$T8_PROJDIR"/$t8dir/t8setup.bash

t8dev="$T8_PROJDIR/t8dev/bin/t8dev"
cd "$T8_PROJDIR"

t8dev buildtoolset asl
t8dev buildtoolset cscp
t8dev buildtoolset RunCPM
t8dev aslauto exe/ src/
(cd - && t8dev pytest -- "$@")  # Use original dir for relative cmd line params

#   This should be parametrised so that the user can decide if she wants to
#   run an emulator on some code after all tests pass and, if so, which
#   emulator on which code.
echo REMOVING FILES
rm -rf .download/rom-image/ .build/emulator/pc8001/
t8dev e cscp pc8001 xxx=foo \
    n80=@0000:https://gitlab.com/â€¦/-/raw/main/rom/80/N80_102.bin
